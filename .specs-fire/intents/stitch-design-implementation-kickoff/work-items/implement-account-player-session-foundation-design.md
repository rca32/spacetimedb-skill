---
work_item: implement-account-player-session-foundation
intent: stitch-design-implementation-kickoff
created: 2026-02-07T15:45:48Z
mode: validate
checkpoint_1: approved
---

# Design: 계정/플레이어/세션 기반 상태 구현

## Summary

`account`/`session_state`/`player_state`를 서버 권위 reducer로 초기화·갱신하고, 인증/인가 실패를 명시적으로 거부하는 최소 안전 경로를 구현한다.
기존 bootstrap 모듈(`item_def`, `player_state`) 위에 인증 기초 테이블과 reducer를 추가한다.

## Scope

**In Scope:**
- `account`, `session_state` 테이블 추가
- `account_bootstrap`, `sign_in`, `sign_out` reducer 구현
- 인증/인가 실패 로그 경로 추가
- 플레이어 초기 상태 조회 경로 정합성 확보

**Out of Scope:**
- 외부 OAuth 연동
- 고도화된 제재 정책 엔진
- 전 지역 세션 분산 락/멀티 디바이스 정책

## Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| 인증 진입점 | `account_bootstrap` + `sign_in` 분리 | 계정/프로필 생성과 세션 생성을 분리해 검증 지점 명확화 |
| 세션 중복 처리 | 동일 Identity 기존 세션은 `sign_in` 시 교체(upsert) | 잔존 세션으로 인한 상태 불일치 방지 |
| 권한 실패 처리 | reducer에서 `Result<_, String>` 즉시 거부 + `log::warn!` | 클라이언트 오류 분기와 감사 가능성 확보 |
| 공개 범위 | `session_state`는 private, `player_state`는 public | 세션 내부 정보 노출 방지 + 플레이어 상태 구독 요구 충족 |
| player_state 보장 | `sign_in` 완료 시 없으면 생성 | 접속 후 조회 경로 일관성 확보 |

## Data Models Affected

### Creates
- **account**: `identity(pk), created_at, status` — 계정 생성 및 상태 추적
- **session_state**: `identity(pk), region_id, last_active_at` — 활성 세션 추적(비공개)

### Modifies
- **player_state**: sign-in 경로에서 멱등 초기화 보장 — 초기 조회 실패 방지

## Technical Approach

### Architecture

```
client_connected / account_bootstrap
  -> ensure account exists
  -> ensure player_state exists

sign_in(region_id)
  -> validate account exists
  -> validate not blocked (hook)
  -> upsert session_state(identity, region_id, last_active_at)
  -> ensure player_state exists

sign_out()
  -> validate session owner
  -> delete session_state
```

### Database Changes

```sql
-- add table account
-- add table session_state (private)
-- keep player_state public and ensure idempotent initialization path
```

## Dependencies

- `.specs-fire/intents/stitch-design-implementation-kickoff/work-items/bootstrap-spacetimedb-module-and-seed.md`
- `DESIGN/05-data-model.md`
- `DESIGN/DETAIL/stitch-authentication-authorization.md`

## Affected Files

| File | Action | Purpose |
|------|--------|---------|
| `stitch-server/crates/game_server/src/lib.rs` | modify | account/session reducer 및 테이블 구현 |
| `stitch-server/README.md` | modify | sign_in/sign_out 검증 명령 및 시나리오 반영 |
| `.specs-fire/runs/run-015/plan.md` | create | validate checkpoint 2 구현 계획 |

## Security Considerations

- **Session disclosure**: `session_state`를 private로 유지해 클라이언트 직접 구독 차단
- **Unauthorized sign_out**: session owner 검증 후 삭제
- **Replay/abuse hook**: 추후 nonce/rate-limit 확장을 위한 검증 포인트 유지

## Integration Points

| System | Type | Purpose |
|--------|------|---------|
| SpacetimeDB reducers | internal | 계정/세션 상태 전이 처리 |
| Public subscription (`player_state`) | read model | 접속 후 플레이어 초기 상태 조회 |

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| 기존 로컬 DB 스키마 충돌 | high | 신규 DB명으로 검증 및 README 충돌 대응 유지 |
| 세션 키 전략 변경 가능성 | medium | 초기엔 Identity 기준 단순 모델 채택, 후속 확장 여지 보존 |
| 제재 정책 미완성 | medium | sign_in에 차단 훅 배치, 후속 validate item에서 강화 |

## Implementation Checklist

- [ ] `account`, `session_state` 테이블 추가
- [ ] `account_bootstrap` reducer 구현
- [ ] `sign_in` reducer 구현
- [ ] `sign_out` reducer 구현
- [ ] 인증/인가 실패 로그 경로 추가
- [ ] build/publish/call/sql 검증 수행 및 test-report 반영

---
*Generated by specs.md - fabriqa.ai FIRE Flow | Checkpoint 1 approved: 2026-02-07T15:45:48Z*
