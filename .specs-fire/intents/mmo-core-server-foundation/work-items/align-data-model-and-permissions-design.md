---
work_item: align-data-model-and-permissions
intent: mmo-core-server-foundation
created: 2026-02-07T14:41:04Z
mode: validate
checkpoint_1: approved
---

# Design: 데이터 모델/권한 설계 정렬

## Summary

`DESIGN/05-data-model-permissions.md` 및 연계 테이블 문서 기준으로 권한 비트/뷰/RLS/리듀서 검증 포인트를 단일 계약으로 정렬한다.

## Scope

**In Scope:**
- `permission_state.flags` 비트 정의 고정
- `building_state`/`claim_state` 조회 뷰의 권한 조건 정렬
- 권한 수정/조회 리듀서의 사전 검증 규칙 정의 (`permission_edit`, `permission_check`)
- owner/admin 우선 규칙 및 `OverrideNoAccess` 충돌 처리 원칙 정의

**Out of Scope:**
- 신규 권한 비트 추가
- UI/클라이언트 권한 UX
- 운영 정책(제재 기준) 상세 튜닝

## Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| 권한 표현 | `u64` 비트마스크(`flags`) 유지 | `perm_view`~`perm_owner`를 조합형으로 다루기 쉽고 조회 조건에 직접 사용 가능 |
| 조회 경계 | `permission_state`는 private/RLS, `building_state`/`claim_state`는 public + 뷰 조건 | 공개 기본정보와 민감 권한정보를 분리해 누출 위험 감소 |
| 권한 우선순위 | `perm_owner` 최상위, `perm_admin`은 관리 행위 한정 | 소유권과 운영 권한 의미를 분리해 정책 충돌 최소화 |
| 검증 위치 | 모든 민감 변경은 reducer 진입 시 검증 | 서버 권위 모델에서 우회 경로 차단 |
| 캐스케이드 평가 | 엔티티 -> 차원 -> 클레임 순 평가, 명시적 차단 우선 | 상세 설계 문서의 권한 체인과 일치 |

## Data Models Affected

### Modifies
- **permission_state**: `flags` 비트 해석 및 subject/target 조합 평가 규칙 명확화 — 권한 판정 일관성 확보
- **building_state**: `building_state_*view`에서 `perm_view`/`perm_owner` 조건 통일 — 조회 경계 일관화
- **claim_state**: `claim_state_*view`에서 `perm_view`/`perm_owner` 조건 통일 — 클레임 조회 정책 정합성 확보

## Technical Approach

### Architecture

```
Reducer Request
  -> permission_check(entity/dimension/claim)
    -> load permission_state(target_id, subject_type, subject_id)
    -> evaluate flags bitmask
    -> allow/deny
  -> mutate/read building_state or claim_state
  -> publish allowed view rows
```

### Database Changes

```sql
-- No new table in this work item.
-- Normalize existing view predicates around perm_view/perm_owner:
-- building_state_partyview/guildview/selfview
-- claim_state_partyview/guildview/selfview
```

## Affected Files

| File | Action | Purpose |
|------|--------|---------|
| `DESIGN/05-data-model-permissions.md` | refine | 권한 비트 정의/우선순위 기준 고정 |
| `DESIGN/05-data-model-tables/permission_state.md` | refine | RLS/뷰 노출/subject_type 규칙 정렬 |
| `DESIGN/05-data-model-tables/building_state.md` | refine | 뷰별 조회 권한 조건 정합화 |
| `DESIGN/05-data-model-tables/claim_state.md` | refine | 뷰별 조회 권한 조건 정합화 |
| `DESIGN/DETAIL/stitch-permission-access-control.md` | refine | `permission_edit`/`permission_check` 검증 포인트 명시 |

## Security Considerations

- **Privilege escalation**: `permission_edit`에서 수정자 권한이 대상 권한 이상인지 검증
- **Data exposure**: private 테이블 직접 노출 금지, self/admin view만 허용
- **Bypass risk**: 모든 도메인 reducer가 공통 `permission_check`를 호출하도록 규약화

## Integration Points

| System | Type | Purpose |
|--------|------|---------|
| Reducers (`permission_edit`, domain reducers) | authz hook | 변경 전 권한 판정 강제 |
| SQL/View subscriptions | read boundary | 조회 데이터 최소화/권한 반영 |

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| 문서 간 권한 용어 불일치 | High | 비트 정의 단일 표를 기준으로 모든 문서 역참조 |
| owner/admin 의미 혼동 | Medium | 액션 매트릭스를 owner/admin 분리 표로 명시 |
| 캐스케이드 순서 불일치 | Medium | 엔티티->차원->클레임 고정 순서를 공통 함수 규약으로 고정 |

## Implementation Checklist

- [ ] 권한 비트/우선순위 표를 `DESIGN/05-data-model-permissions.md` 단일 기준으로 정리
- [ ] `permission_state` RLS/뷰 규칙의 subject_type 범위와 예외 조건 정리
- [ ] `building_state`/`claim_state` 뷰 조건을 동일 패턴으로 정렬
- [ ] reducer 검증 포인트 표 (`permission_edit`, `permission_check`, 주요 도메인 reducer) 작성
- [ ] 정책 문구에서 외부 레퍼런스 근거를 제거하고 프로젝트 기준으로 고정

---
*Generated by specs.md - fabriqa.ai FIRE Flow | Checkpoint 1 approved: 2026-02-07T14:41:04Z*
