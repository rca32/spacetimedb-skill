---
work_item: implement-astar-pathfinding
intent: stitch-server-critical-gaps-implementation
created: 2026-02-04T00:00:00Z
mode: validate
checkpoint_1: approved
---

# Design: Implement A* pathfinding algorithm

## Summary

Implement A* pathfinding over axial hex coordinates using existing tables for costs and obstacles, with a node limit for server safety and unit tests that validate straight, detour, and no-path scenarios.

## Scope

**In Scope:**
- A* pathfinding over `HexCoordinates` with `HexDirection::all()` neighbors
- Terrain cost from `nav_cell_cost.terrain_cost`
- Blocking from `nav_cell_cost.blocked` and `nav_obstacle.blocked`
- Hex-distance heuristic
- Node limit enforcement with `None` on failure
- Unit tests for straight line, obstacle detour, and no-path

**Out of Scope:**
- Path caching and crowd/hazard costs beyond `nav_cell_cost`
- Client reducers for path requests
- Multi-dimension support beyond current dimension=0 handling

## Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Coordinate model | Axial hex (`HexCoordinates`) with 6 neighbors | Matches existing `world_gen` helpers and current pathfinding stub |
| Open set | `BinaryHeap` with duplicate entries | Simple, performant, and avoids decrease-key complexity |
| Cost model | `1.0 * terrain_cost` with blocked=INFINITY | Aligns with `nav_cell_cost` schema and current stub behavior |
| Obstacle handling | Check `nav_obstacle.blocked` and `nav_cell_cost.blocked` | Ensures hard-blocks are respected |
| Heuristic | Hex distance `(dx+dy+dz)/2` | Admissible for hex grids and already available via `distance_to` |
| Node limit behavior | Return `None` when exceeded | Meets acceptance criteria and protects server runtime |

## Data Models Affected

### Modifies
- **nav_cell_cost**: read `terrain_cost`, `blocked` — used for movement cost and impassable cells
- **nav_obstacle**: read `blocked`, `x`, `z`, `dimension` — used for obstacle blocking

## Technical Approach

### Architecture

```
[Reducers/Agents] -> [Pathfinding Service]
                        |
                        v
               [nav_cell_cost / nav_obstacle]
                        |
                        v
                  [A* Path Output]
```

## Dependencies

- add-player-state-creation (for typical path targets)

## Affected Files

| File | Action | Purpose |
|------|--------|---------|
| `stitch-server/crates/game_server/src/services/pathfinding.rs` | modify | Finalize A* logic and node-limit handling |
| `stitch-server/crates/game_server/tests/pathfinding_tests.rs` | create | Unit tests for straight, detour, and no-path scenarios |

## Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| Node limit too low for 50-tile paths | medium | Use higher limit in tests and document default recommendations |
| Dimension not encoded in `cell_key` | medium | Keep dimension=0 for now; extend key when multi-dimension pathing is needed |
| High terrain costs create large f32 values | low | Clamp terrain_cost minimum to 1.0; treat blocked as infinity |

## Implementation Checklist

- [ ] Align `find_path` signature and behavior to work item acceptance criteria
- [ ] Ensure obstacle and terrain block checks are consistent
- [ ] Enforce node_limit with `None` return
- [ ] Add unit tests for straight path, detour, and no-path
- [ ] Validate heuristic uses hex distance

---
*Generated by specs.md - fabriqa.ai FIRE Flow | Checkpoint 1 approved: 2026-02-04T00:00:00Z*
