# Coding Standards

## Overview

SpacetimeDB 서버 모듈 설계/구현 시 서버 권위, 입력 검증, 테이블 무결성, 구독 최소화를 우선한다.

## Code Formatting

**Tool**: rustfmt
**Config**: default
**Enforcement**: pre-commit or CI check

### Key Settings

- **edition**: 2021
- **line width**: rustfmt default

## Linting

**Tool**: clippy
**Base Config**: default + `-D warnings` 권장
**Strictness**: high

### Key Rules

- `unwrap_used`: deny - 서버 패닉 방지
- `todo`: deny - 미완료 로직 커밋 방지
- `panic`: warn - 의도적 패닉 금지

## Naming Conventions

### Variables and Functions

| Element | Convention | Example |
|---------|------------|---------|
| Reducer | `snake_case` | `player_regen_agent_loop` |
| Table | `snake_case` | `resource_state` |
| Type/Struct | `PascalCase` | `ResourceState` |
| Constant | `SCREAMING_SNAKE_CASE` | `CHUNK_WIDTH` |

### Files and Folders

- **module files**: `snake_case.rs` (e.g., `player_regen_agent.rs`)
- **design docs**: `kebab-case.md` (e.g., `world-generation-system.md`)

## File Organization

### Project Structure

```
DESIGN/
.specs-fire/
stitch-server/ (runtime code when implemented)
```

### Conventions

- **Reducer placement**: domain module별로 분리
- **Table definition**: 스키마 중심 파일에 집중
- **Design linkage**: 코드 항목은 DESIGN 섹션 ID를 참조

## Import Order

```rust
use std::time::Duration;
use spacetimedb::{ReducerContext, Table, Timestamp};
```

**Rules**:
- std 먼저, 외부 크레이트 다음, 내부 모듈 마지막
- wildcard import 지양

## Error Handling

### Pattern

**Approach**: early return + explicit validation

### Guidelines

- reducer 시작 시 입력/권한 검증
- 실패 시 의미 있는 오류 메시지 반환
- scheduled reducer는 server/admin 호출만 허용

### Example

```rust
if !is_authorized(ctx.sender) {
    return Err("unauthorized".into());
}
```

## Logging

**Tool**: structured logging (crate policy TBD)
**Format**: key-value

### Log Levels

| Level | Usage |
|-------|-------|
| info | 정상 상태 전이 |
| warn | 재시도 가능 이상 상태 |
| error | 무결성/권한/보안 위반 |

### Guidelines

**Always log**:
- 인증/권한 실패
- anti-cheat 위반 판정
- 스케줄러 핵심 상태 변경

**Never log**:
- 토큰/비밀값
- 개인정보 원문

## Comments and Documentation

### When to Comment

- 정책성 검증(예: 쿨다운, 속도 제한) 근거를 설명할 때
- 테이블/필드가 DESIGN 요구사항과 연결될 때

### Documentation Format

**Functions**: Rust doc comments
**Classes**: Rust doc comments

## Code Patterns

### Preferred Patterns

#### Server-authoritative reducers

상태 변경은 reducer 내에서만 처리하고 클라이언트는 요청만 전송한다.

```rust
// reducer validates and mutates authoritative state
```

### Anti-Patterns to Avoid

- **client-authoritative state**: 동기화/치트 취약점 증가
- **implicit permission checks**: 보안 검토 누락 유발
- **broad subscriptions**: 네트워크/서버 부하 증가

---
*Generated by specs.md - fabriqa.ai FIRE Flow*
