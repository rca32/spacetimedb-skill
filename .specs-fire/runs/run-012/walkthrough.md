---
run: run-012
work_item: align-data-model-and-permissions
intent: mmo-core-server-foundation
generated: 2026-02-07T15:07:07Z
mode: validate
---

# Implementation Walkthrough: 데이터 모델/권한 설계 정렬

## Summary
`permission_state.flags` 기준의 권한 계약을 단일 기준으로 재정렬했다. `permission_state`는 private/RLS 경계로 유지하고, `building_state`/`claim_state`는 public + 권한 뷰 조건으로 일관화했다. 또한 `permission_edit`/`permission_check`를 중심으로 reducer 진입 검증 포인트를 명시해 권한 검증 경로를 고정했다.

## Structure Overview
권한 원본은 `permission_state`에서만 관리하고, 조회 계층은 각 도메인 테이블 뷰에서 필요한 최소 조건(`perm_view`, `perm_owner`)만 평가한다. 상태 변경 계층은 도메인 reducer에서 공통 `permission_check`를 선호출하도록 맞춰 권한 판정 로직 분산을 방지한다.

## Files Changed

### Created

| File | Purpose |
|------|---------|
| (none) | |

### Modified

| File | Changes |
|------|---------|
| `DESIGN/05-data-model-permissions.md` | 권한 비트/우선순위/테이블 적용/reducer 검증 기준 단일화 |
| `DESIGN/05-data-model-tables/permission_state.md` | subject_type 정의, self/admin view 규칙, RLS 원칙 정렬 |
| `DESIGN/05-data-model-tables/building_state.md` | party/guild/self view를 subject_type 기반으로 정렬 |
| `DESIGN/05-data-model-tables/claim_state.md` | party/guild/self view를 subject_type 기반으로 정렬 |
| `DESIGN/DETAIL/stitch-permission-access-control.md` | 구식 enum 기반 서술 제거, 비트마스크/검증 포인트 중심으로 재작성 |

## Key Implementation Details

### 1. 권한 우선순위 고정
`perm_owner > perm_admin > 기능 비트` 순서를 명시해 문서 간 충돌을 제거했다.

### 2. 조회 경계 표준화
`building_state`와 `claim_state`의 view 조건을 동일 패턴으로 정리해 접근 정책을 통일했다.

### 3. reducer 권한 검증 포인트 명시
`permission_edit`, `permission_check`, 도메인 민감 reducer의 entry validation과 auth check를 표로 고정했다.

## Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| 권한 모델 기준 | `permission_state.flags` 비트마스크 유지 | 기존 DESIGN 데이터 모델과 정합성 유지 |
| 접근 경계 | `permission_state` private, 도메인 상태 public+view 제한 | 민감 권한 정보 노출 최소화 |
| 검증 경로 | 민감 reducer는 `permission_check` 선호출 | 권한 로직 분산/누락 방지 |

## Deviations from Plan
None

## Dependencies Added

| Package | Why Needed |
|---------|------------|
| (none) | |

## How to Verify

1. **권한 플래그 및 검증 포인트 존재 확인**
```bash
rg -n "perm_view|perm_use|perm_build|perm_inventory|perm_trade|perm_admin|perm_owner|permission_edit|permission_check" \
  DESIGN/05-data-model-permissions.md \
  DESIGN/05-data-model-tables/permission_state.md \
  DESIGN/05-data-model-tables/building_state.md \
  DESIGN/05-data-model-tables/claim_state.md \
  DESIGN/DETAIL/stitch-permission-access-control.md
```
Expected: 핵심 키워드가 모두 검색됨.

2. **외부 의존 문구 제거 확인**
```bash
rg -n "BitCraft|OverrideNoAccess|CoOwner|ordained_entity_id|allowed_entity_id" \
  DESIGN/05-data-model-permissions.md \
  DESIGN/05-data-model-tables/permission_state.md \
  DESIGN/05-data-model-tables/building_state.md \
  DESIGN/05-data-model-tables/claim_state.md \
  DESIGN/DETAIL/stitch-permission-access-control.md
```
Expected: 결과 없음.

## Test Coverage
- Tests added: 0
- Coverage: N/A (문서 작업)
- Status: passing

## Developer Notes
실구현 단계에서는 문서의 `building_*`, `claim_*` 패턴을 실제 reducer 이름으로 매핑해 drift를 방지해야 한다.

---
*Generated by specs.md - fabriqa.ai FIRE Flow Run run-012*
