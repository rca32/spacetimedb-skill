---
run: run-002
work_item: migrate-auth-session-movement-foundation-into-domain-modules
intent: stitch-full-game-server-development
generated: 2026-02-07T16:21:40Z
mode: validate
---

# Implementation Walkthrough: 기존 인증/세션/이동 기반을 도메인 모듈로 이전

## Summary

`lib.rs`에 집중돼 있던 인증/세션/이동 기반 로직을 `tables/`, `auth/`, `reducers/player/`, `validation/anti_cheat.rs`로 분리했다.
기능 동등성 유지를 우선해 reducer 이름/동작은 유지했고, 컴파일 및 실제 CLI 호출로 회귀가 없음을 확인했다.

## Structure Overview

테이블 선언은 `tables/*` 파일로 분리하고 `tables/mod.rs`에서 재노출했다.
인증/세션 진입점(`account_bootstrap`, `sign_in`, `sign_out`)은 `auth/*`로 이동했고, 이동 처리(`move_to`)는 `reducers/player/move_player.rs`로 이동했다.
이동 검증/위반 기록은 `validation/anti_cheat.rs`로 분리해 검증 책임을 reducer 본문에서 분리했다.

## Files Changed

### Created

| File | Purpose |
|------|---------|
| `stitch-server/crates/game_server/src/tables/account.rs` | account 테이블 분리 |
| `stitch-server/crates/game_server/src/tables/item_def.rs` | item_def 테이블 분리 |
| `stitch-server/crates/game_server/src/tables/player_state.rs` | player_state 테이블 분리 |
| `stitch-server/crates/game_server/src/tables/session_state.rs` | session_state 테이블 분리 |
| `stitch-server/crates/game_server/src/tables/transform_state.rs` | transform_state 테이블 분리 |
| `stitch-server/crates/game_server/src/tables/movement.rs` | movement_* 테이블 분리 |
| `stitch-server/crates/game_server/src/auth/account_bootstrap.rs` | account_bootstrap reducer 분리 |
| `stitch-server/crates/game_server/src/auth/sign_in.rs` | sign_in reducer 분리 |
| `stitch-server/crates/game_server/src/auth/sign_out.rs` | sign_out reducer 분리 |
| `stitch-server/crates/game_server/src/reducers/player/mod.rs` | player reducer 모듈 엔트리 |
| `stitch-server/crates/game_server/src/reducers/player/move_player.rs` | move_to reducer 분리 |
| `stitch-server/crates/game_server/src/validation/anti_cheat.rs` | 이동 검증/위반 기록 로직 분리 |
| `.specs-fire/runs/run-002/plan.md` | 구현 계획 |
| `.specs-fire/runs/run-002/test-report.md` | 검증 결과 |
| `.specs-fire/runs/run-002/review-report.md` | 코드 리뷰 결과 |
| `.specs-fire/runs/run-002/walkthrough.md` | 구현 워크스루 |

### Modified

| File | Changes |
|------|---------|
| `stitch-server/crates/game_server/src/lib.rs` | seed/import reducer만 유지하고 도메인 모듈 조립점으로 정리 |
| `stitch-server/crates/game_server/src/auth/mod.rs` | auth helper/서브모듈 연결 |
| `stitch-server/crates/game_server/src/tables/mod.rs` | 도메인 테이블 재노출 |
| `stitch-server/crates/game_server/src/reducers/mod.rs` | player 하위 reducer 모듈 연결 |
| `stitch-server/crates/game_server/src/validation/mod.rs` | anti_cheat 모듈 연결 |
| `stitch-server/crates/game_server/src/module.rs` | client_connected에서 auth helper 사용하도록 정리 |

## Key Implementation Details

### 1. Table Trait Scope Handling

SpacetimeDB는 테이블별 접근 trait가 모듈 스코프에 있어야 하므로, 각 파일에 해당 trait import를 명시해 모듈 분리 후도 `ctx.db.<table>()` 접근이 유지되게 했다.

### 2. Reducer Behavior Preservation

`move_to`의 멱등 처리, 세션/리전 검증, timestamp/거리 검증, 위반 시 no-op+로그 커밋 동작을 그대로 유지한 채 파일 위치만 도메인 기준으로 이동했다.

### 3. Validation Boundary Split

요청 ID 검증, 중복 요청 판정, actor progression 검증, 위반 로그 적재를 `validation/anti_cheat.rs`로 분리해 reducer 본문이 흐름 제어 중심이 되도록 정리했다.

## Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| 리팩터링 방식 | 동작 보존 우선의 파일 분리 | 회귀 위험을 낮추고 acceptance의 "동등성" 충족 |
| 검증 로직 위치 | `validation/anti_cheat.rs`로 집약 | 이동 reducer 책임 축소 및 재사용성 향상 |
| trait import 정책 | 각 파일에서 명시 import | SpacetimeDB 매크로 생성 trait의 스코프 요구 충족 |

## Deviations from Plan

- `item_def`도 함께 `tables/item_def.rs`로 분리했다.
- 이유: `lib.rs`를 조립점으로 단순화하고 테이블 선언 위치를 일관화하기 위해서다.

## Dependencies Added

| Package | Why Needed |
|---------|------------|
| (none) | 기존 의존성만 사용 |

## How to Verify

1. **Compile + Build**
```bash
cd stitch-server
cargo check -p game_server
cd crates/game_server
spacetime build
```
Expected: check/build 성공

2. **CLI Regression Flow**
```bash
spacetime start
cd stitch-server/crates/game_server
spacetime publish --server 127.0.0.1:3000 stitch-server-run002
spacetime call --server 127.0.0.1:3000 stitch-server-run002 account_bootstrap "player-two"
spacetime call --server 127.0.0.1:3000 stitch-server-run002 sign_in 1
spacetime call --server 127.0.0.1:3000 stitch-server-run002 move_to "req-1" 1 1000 1.0 0.0 0.0
spacetime call --server 127.0.0.1:3000 stitch-server-run002 sign_out
spacetime sql --server 127.0.0.1:3000 stitch-server-run002 "SELECT * FROM movement_request_log"
spacetime sql --server 127.0.0.1:3000 stitch-server-run002 "SELECT * FROM movement_violation"
```
Expected: movement_request_log에 accepted=true 1건, movement_violation empty

## Test Coverage

- Tests added: 0
- Coverage: 0%
- Status: passing

## Developer Notes

- `spacetime start`를 일반 백그라운드로 띄우면 환경에 따라 유지되지 않을 수 있어 PTY 세션 방식이 안정적이었다.

---
*Generated by specs.md - fabriqa.ai FIRE Flow Run run-002*
