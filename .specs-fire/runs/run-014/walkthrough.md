---
run: run-014
work_item: bootstrap-spacetimedb-module-and-seed
intent: stitch-design-implementation-kickoff
generated: 2026-02-07T15:39:34Z
mode: confirm
---

# Implementation Walkthrough: SpacetimeDB 모듈 부트스트랩 및 시드 경로 확정

## Summary

`stitch-server`에 비어 있던 `game_server` 모듈 소스(`src/lib.rs`)를 생성해 최소 동작 가능한 SpacetimeDB 테이블/리듀서 구성을 추가했다.
`seed_data`, `import_csv_data`, `import_csv_by_type` 경로를 제공하고, 로컬 서버에서 build/publish/call/sql 검증을 수행해 부트스트랩 실행 흐름을 확인했다.

## Structure Overview

모듈은 `item_def`와 `player_state` 두 개의 기본 public table을 제공하고, 시드 리듀서가 초기 `item_def` 데이터를 삽입한다.
클라이언트 연결 시 `player_state` 기본 행을 생성하도록 하여 향후 계정/세션 work item과 연결 가능한 최소 상태 구조를 준비했다.

## Files Changed

### Created

| File | Purpose |
|------|---------|
| `stitch-server/crates/game_server/src/lib.rs` | 최소 SpacetimeDB 테이블 및 부트스트랩 리듀서 구현 |

### Modified

| File | Changes |
|------|---------|
| `stitch-server/README.md` | 실행/시드/검증 명령 정리 및 기존 DB 스키마 충돌 대응 절차 추가 |

## Key Implementation Details

### 1. Minimal bootstrap tables and reducers

`item_def`, `player_state`를 정의하고 `seed_data`에서 아이템 샘플 2건을 멱등 삽입한다. `import_csv_data`, `import_csv_by_type("items")`는 bootstrap 단계에서 시드 경로를 재사용한다.

### 2. Connection-time player initialization

`client_connected` reducer에서 `player_state`가 없는 경우 기본 행을 삽입해 초기 플레이어 상태 조회 기반을 마련했다.

### 3. CLI verification path stabilization

`README`에 `--server 127.0.0.1:3000` 옵션을 명시하고, 기존 `stitch-server` DB의 스키마 충돌 시 `--delete-data` 또는 신규 DB명 사용 절차를 추가했다.

## Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Bootstrap schema scope | Keep only `item_def` and `player_state` | 초기 착수 단계에서 build/publish/seed 경로 검증에 필요한 최소 범위 확보 |
| CSV reducers behavior | Route to deterministic seed behavior | 실제 CSV 파이프라인 구현 전에도 CLI 계약 유지 |
| Publish conflict handling | Document `--delete-data` or fresh DB name | 기존 로컬 DB 상태로 인한 manual migration 차단을 우회해 재현 가능한 검증 보장 |

## Deviations from Plan

`stitch-server` 이름으로 publish 검증 시 기존 DB 스키마와 충돌해 manual migration 요구가 발생했다.
계획의 목적(부트스트랩 검증) 달성을 위해 `stitch-server-bootstrap` DB명을 사용해 publish/call/sql 경로를 검증하고 README에 운영 대응 절차를 명시했다.

## Dependencies Added

| Package | Why Needed |
|---------|------------|
| (none) | |

## How to Verify

1. **Build module**
   ```bash
   cd /home/rca32/workspaces/spacetimedb-skill/stitch-server/crates/game_server
   spacetime build
   ```
   Expected: `Build finished successfully.`

2. **Publish module**
   ```bash
   spacetime publish --server 127.0.0.1:3000 stitch-server-bootstrap
   ```
   Expected: database created or updated without migration error.

3. **Seed and query**
   ```bash
   spacetime call --server 127.0.0.1:3000 stitch-server-bootstrap seed_data
   spacetime sql --server 127.0.0.1:3000 stitch-server-bootstrap "SELECT COUNT(*) AS item_def_count FROM item_def"
   ```
   Expected: `item_def_count` >= 2.

## Test Coverage

- Tests added: 0
- Coverage: 0%
- Status: passing

## Developer Notes

로컬 환경에 기존 `stitch-server` DB가 남아 있으면 스키마 삭제/컬럼 변경으로 publish가 막힐 수 있다. 이 경우 `--delete-data`로 재배포하거나 새 DB명으로 검증을 진행해야 한다.

---
*Generated by specs.md - fabriqa.ai FIRE Flow Run run-014*
