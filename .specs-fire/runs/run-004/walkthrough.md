---
run: run-004
work_item: implement-building-and-claim-core-reducers
intent: stitch-full-game-server-development
generated: 2026-02-07T16:34:30Z
mode: validate
---

# Implementation Walkthrough: 건설/클레임 코어 리듀서 구현

## Summary

건설/클레임 코어 경로를 위해 `building_state`, `claim_state`, `permission_state`를 추가하고 핵심 reducer 5종을 구현했다.
건설 배치 시 인벤토리 재료를 소모하고, 진행 완료 후 클레임 토템 배치/확장, 해체 시 환급까지 서버 권위로 처리되도록 연결했다.

## Structure Overview

건설 도메인은 `reducers/building/*`, 클레임 도메인은 `reducers/claim/*`로 분리했다.
권한 판단은 `services/permissions.rs`의 공통 비트 검사로 통일했고, 재료 소모/환급은 building reducer 내부 공통 함수로 처리했다.

## Files Changed

### Created

| File | Purpose |
|------|---------|
| `stitch-server/crates/game_server/src/tables/building_state.rs` | 건설 상태 테이블 |
| `stitch-server/crates/game_server/src/tables/claim_state.rs` | 클레임 상태 테이블 |
| `stitch-server/crates/game_server/src/tables/permission_state.rs` | 권한 비트 저장 테이블 |
| `stitch-server/crates/game_server/src/reducers/building/mod.rs` | building reducer 엔트리 |
| `stitch-server/crates/game_server/src/reducers/building/building_place.rs` | 건설 배치 + 재료 소모 |
| `stitch-server/crates/game_server/src/reducers/building/building_advance.rs` | 건설 진행/완료 전이 |
| `stitch-server/crates/game_server/src/reducers/building/building_deconstruct.rs` | 해체 + 재료 환급 |
| `stitch-server/crates/game_server/src/reducers/claim/mod.rs` | claim reducer 엔트리 |
| `stitch-server/crates/game_server/src/reducers/claim/claim_totem_place.rs` | 클레임 토템 배치 |
| `stitch-server/crates/game_server/src/reducers/claim/claim_expand.rs` | 클레임 반경 확장 |
| `stitch-server/crates/game_server/src/services/permissions.rs` | 공통 권한 체크 서비스 |
| `.specs-fire/runs/run-004/plan.md` | 구현 계획 |
| `.specs-fire/runs/run-004/test-report.md` | 테스트 리포트 |
| `.specs-fire/runs/run-004/review-report.md` | 리뷰 리포트 |
| `.specs-fire/runs/run-004/walkthrough.md` | 구현 워크스루 |

### Modified

| File | Changes |
|------|---------|
| `stitch-server/crates/game_server/src/tables/mod.rs` | building/claim/permission 테이블 모듈 등록 |
| `stitch-server/crates/game_server/src/reducers/mod.rs` | building/claim reducer 모듈 등록 |
| `stitch-server/crates/game_server/src/services/mod.rs` | permissions 서비스 모듈 등록 |

## Key Implementation Details

### 1. Build Placement Validation

`building_place`에서 세션/리전 일치, 플레이어-배치 지점 거리(<=20), 클레임 권한(`PERM_BUILD`)을 먼저 검증한 뒤 재료를 소비하고 프로젝트 상태 건물을 생성한다.

### 2. State Transition

`building_advance`는 `state=0` 프로젝트 상태에서만 진행되며 `build_progress >= build_required` 시 `state=1` 완공으로 전이한다.
`building_deconstruct`는 권한 검증 후 환급을 처리하고 `state=2`로 전이한다.

### 3. Claim Core Rules

`claim_totem_place`는 완공된 토템 건물만 허용하고 기존 클레임과 최소 거리 규칙을 적용한다.
`claim_expand`는 소유자 또는 `PERM_ADMIN` 권한만 허용하며, 호출자-클레임 중심 거리 검증을 수행한다.

## Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| 재료 소비 시점 | `building_place`에서 선소모 | 최소 코어 단계에서 정합성 단순화 |
| 해체 환급 정책 | 요구 재료의 50% 환급 | 상태 전이 + 경제 루프 기본 검증 목적 |
| 권한 비트 | claim/building 공통 `PERM_BUILD/PERM_ADMIN` 사용 | reducer별 중복 권한 로직 축소 |

## Deviations from Plan

- None

## Dependencies Added

| Package | Why Needed |
|---------|------------|
| (none) | 기존 의존성만 사용 |

## How to Verify

1. **Build**
```bash
cd stitch-server
cargo check -p game_server
cd crates/game_server
spacetime build
```
Expected: check/build success

2. **Core Building/Claim Flow**
```bash
spacetime start
cd stitch-server/crates/game_server
spacetime publish --server 127.0.0.1:3000 stitch-server-run004
spacetime call --server 127.0.0.1:3000 stitch-server-run004 account_bootstrap "player-four"
spacetime call --server 127.0.0.1:3000 stitch-server-run004 sign_in 1
spacetime call --server 127.0.0.1:3000 stitch-server-run004 seed_data
spacetime call --server 127.0.0.1:3000 stitch-server-run004 inventory_bootstrap
spacetime call --server 127.0.0.1:3000 stitch-server-run004 building_place 1001 1 2 2 1 2 2
spacetime call --server 127.0.0.1:3000 stitch-server-run004 building_advance 1001 2
spacetime call --server 127.0.0.1:3000 stitch-server-run004 claim_totem_place 2001 1001 3
spacetime call --server 127.0.0.1:3000 stitch-server-run004 claim_expand 2001 1
spacetime call --server 127.0.0.1:3000 stitch-server-run004 building_deconstruct 1001
spacetime sql --server 127.0.0.1:3000 stitch-server-run004 "SELECT entity_id,state,build_progress,build_required FROM building_state"
spacetime sql --server 127.0.0.1:3000 stitch-server-run004 "SELECT claim_id,radius,tier FROM claim_state"
```
Expected: `building_state.state=2`, `claim_state.radius=4`

## Test Coverage

- Tests added: 0
- Coverage: 0%
- Status: passing

## Developer Notes

- 현재 구현은 최소 코어 루프에 초점을 맞췄고, footprint 충돌/지형 검사/세부 권한 계층은 후속 고도화 단계로 분리하는 것이 안전하다.

---
*Generated by specs.md - fabriqa.ai FIRE Flow Run run-004*
