---
run: run-015
work_item: implement-account-player-session-foundation
intent: stitch-design-implementation-kickoff
generated: 2026-02-07T15:49:56Z
mode: validate
---

# Implementation Walkthrough: 계정/플레이어/세션 기반 상태 구현

## Summary

`game_server` 모듈에 계정/세션 기반 상태 테이블(`account`, `session_state`)과 인증 경로 reducer(`account_bootstrap`, `sign_in`, `sign_out`)를 추가했다.
기존 `player_state` 초기화 경로를 계정/세션 흐름과 맞추고, 실패 입력을 명시적으로 거부하는 검증 로직을 도입했다.

## Structure Overview

연결 시점(`client_connected`)에는 계정/플레이어 기본 행만 보장하고, 실제 세션 활성화는 `sign_in`에서만 처리한다.
`session_state`는 private table로 유지되어 외부 구독 노출을 막고, `sign_out`에서 identity 소유 세션만 제거하는 단일 경로를 사용한다.

## Files Changed

### Created

| File | Purpose |
|------|---------|
| (none) | |

### Modified

| File | Changes |
|------|---------|
| `stitch-server/crates/game_server/src/lib.rs` | account/session_state 테이블 및 인증/세션 reducer 추가, 검증/거부 경로 반영 |
| `stitch-server/README.md` | auth/session 검증 절차 및 DB identity fallback 안내 추가 |

## Key Implementation Details

### 1. Account/session table foundation

`account`는 identity 기반 계정 상태를 저장하고, `session_state`는 private table로 active session을 추적한다.

### 2. Reducer-level validation and rejection

`account_bootstrap`는 빈 display name을 거부하고, `sign_in`은 account status 검사 후 세션을 upsert한다.

### 3. Consistent player initialization

`ensure_player_state_exists` 헬퍼를 통해 연결/로그인 경로 모두에서 `player_state` 존재를 멱등 보장한다.

## Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Session keying | `session_state` primary key를 `identity`로 단순화 | 초기 착수 단계에서 중복 세션 방지와 업데이트 경로 단순화 |
| Sign-in policy | 계정이 없으면 생성 후 sign-in 진행 | bootstrap 단계에서 개발/테스트 진입 장벽 최소화 |
| Failure visibility | 입력 검증 실패를 `Result` 오류로 반환 | 클라이언트와 테스트에서 실패 원인을 즉시 식별 가능 |

## Deviations from Plan

검증 중 새 DB명을 CLI에서 즉시 이름으로 조회하지 못해(404), publish 결과의 DB identity를 사용해 call/sql 검증을 수행했다.
README에 동일 상황 대응(Identity fallback) 가이드를 추가했다.

## Dependencies Added

| Package | Why Needed |
|---------|------------|
| (none) | |

## How to Verify

0. **Build module**
   ```bash
   cd /home/rca32/workspaces/spacetimedb-skill/stitch-server/crates/game_server
   spacetime build
   ```
   Expected: build success.

1. **Publish auth test DB**
   ```bash
   spacetime publish --server 127.0.0.1:3000 stitch-server-auth
   ```
   Expected: DB created/updated.

2. **Bootstrap and sign-in**
   ```bash
   spacetime call --server 127.0.0.1:3000 <db_identity> account_bootstrap "player-one"
   spacetime call --server 127.0.0.1:3000 <db_identity> sign_in 1
   ```
   Expected: both succeed.

3. **Check state transitions**
   ```bash
   spacetime sql --server 127.0.0.1:3000 <db_identity> "SELECT COUNT(*) FROM account"
   spacetime sql --server 127.0.0.1:3000 <db_identity> "SELECT COUNT(*) FROM player_state"
   spacetime sql --server 127.0.0.1:3000 <db_identity> "SELECT COUNT(*) FROM session_state"
   ```
   Expected: account/player_state >= 1, session_state = 1.

4. **Sign-out and failure case**
   ```bash
   spacetime call --server 127.0.0.1:3000 <db_identity> sign_out
   spacetime call --server 127.0.0.1:3000 <db_identity> account_bootstrap ""
   ```
   Expected: sign_out success, empty display_name call fails with validation error.

## Test Coverage

- Tests added: 0
- Coverage: 0%
- Status: passing

## Developer Notes

이 단계는 계정/세션의 최소 서버 권위 경로 구현에 집중했다. role_binding/moderation 정교화와 다중 세션 정책은 후속 validate 항목에서 확장하는 것이 안전하다.

---
*Generated by specs.md - fabriqa.ai FIRE Flow Run run-015*
