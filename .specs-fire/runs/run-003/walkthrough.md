---
run: run-003
work_item: implement-inventory-container-slot-item-loop
intent: stitch-full-game-server-development
generated: 2026-02-07T16:28:20Z
mode: confirm
---

# Implementation Walkthrough: 인벤토리 컨테이너/슬롯/아이템 루프 구현

## Summary

인벤토리 최소 루프를 위해 컨테이너/슬롯/인스턴스/스택/잠금 테이블을 추가하고, 슬롯 이동 reducer를 구현했다.
플레이어 인벤토리 초기화(`inventory_bootstrap`)와 슬롯 이동(`item_stack_move`)이 동작하며, 잠금/용량 검증이 서버에서 수행되도록 구성했다.

## Structure Overview

`tables/`는 인벤토리 핵심 엔터티를 분리 정의하고, `reducers/inventory/`는 부트스트랩/이동/잠금 제어를 담당한다.
용량 계산은 `services/economy.rs`로 분리해 reducer에서 정책 검증 호출만 수행하도록 구성했다.

## Files Changed

### Created

| File | Purpose |
|------|---------|
| `stitch-server/crates/game_server/src/tables/inventory_container.rs` | 인벤토리 컨테이너 테이블 |
| `stitch-server/crates/game_server/src/tables/inventory_slot.rs` | 슬롯 테이블 |
| `stitch-server/crates/game_server/src/tables/item_instance.rs` | 아이템 인스턴스 테이블 |
| `stitch-server/crates/game_server/src/tables/item_stack.rs` | 스택 수량 테이블 |
| `stitch-server/crates/game_server/src/tables/inventory_lock.rs` | 컨테이너 잠금 테이블 |
| `stitch-server/crates/game_server/src/reducers/inventory/mod.rs` | inventory reducer 엔트리 |
| `stitch-server/crates/game_server/src/reducers/inventory/inventory_bootstrap.rs` | 기본 컨테이너/슬롯 생성 reducer |
| `stitch-server/crates/game_server/src/reducers/inventory/item_stack_move.rs` | 슬롯 간 이동/스택 병합 reducer |
| `stitch-server/crates/game_server/src/reducers/inventory/inventory_lock.rs` | 잠금/잠금해제 reducer |
| `stitch-server/crates/game_server/src/services/economy.rs` | 슬롯 용량 검증 헬퍼 |
| `.specs-fire/runs/run-003/plan.md` | 구현 계획 |
| `.specs-fire/runs/run-003/test-report.md` | 테스트 리포트 |
| `.specs-fire/runs/run-003/review-report.md` | 리뷰 리포트 |
| `.specs-fire/runs/run-003/walkthrough.md` | 구현 워크스루 |

### Modified

| File | Changes |
|------|---------|
| `stitch-server/crates/game_server/src/tables/item_def.rs` | `item_def_id/category/rarity/volume/max_stack` 중심으로 정렬 |
| `stitch-server/crates/game_server/src/tables/mod.rs` | inventory/item 관련 모듈 재노출 |
| `stitch-server/crates/game_server/src/reducers/mod.rs` | `inventory` reducer 모듈 연결 |
| `stitch-server/crates/game_server/src/services/mod.rs` | `economy` 서비스 모듈 연결 |
| `stitch-server/crates/game_server/src/lib.rs` | seed_data를 신규 item_def 스키마에 맞게 갱신 |

## Key Implementation Details

### 1. Inventory Bootstrap Path

`inventory_bootstrap`가 플레이어별 기본 컨테이너와 빈 슬롯을 생성하고, 테스트 가능한 starter stack(wood x10)을 slot 0에 적재한다.

### 2. Server-side Move Validation

`item_stack_move`는 소유자/잠금/빈 슬롯/아이템 타입/`max_stack`/슬롯 용량을 모두 서버에서 검증한다.
동일 아이템 대상 슬롯으로 이동 시 스택 병합, 빈 슬롯 이동 시 전체 이동 또는 분할 이동을 지원한다.

### 3. Lock Gate

컨테이너 잠금 상태에서 이동 reducer 호출 시 즉시 `container is locked`로 차단되어 거래/제작 잠금 시나리오의 기본 안전장치를 제공한다.

## Decisions Made

| Decision | Choice | Rationale |
|----------|--------|-----------|
| 슬롯 PK 설계 | `(container_id, slot_index)` 대신 `slot_key` 문자열 PK | SpacetimeDB에서 단일 PK 기반 접근 경로를 단순화 |
| 초기 적재 데이터 | bootstrap 시 starter stack 자동 생성 | 조회/이동 루프를 즉시 검증 가능하게 하기 위함 |
| 잠금 reducer 이름 | `inventory_lock` 대신 `lock_inventory_container` | table 이름과의 심볼 충돌 회피 |

## Deviations from Plan

- 계획서에 `inventory_lock`/`inventory_unlock` reducer 명시했지만, 구현은 `lock_inventory_container`/`unlock_inventory_container`로 변경.
- 이유: `inventory_lock` table 이름과 동일 시 `spacetime build`에서 심볼 중복 에러 발생.

## Dependencies Added

| Package | Why Needed |
|---------|------------|
| (none) | 기존 의존성만 사용 |

## How to Verify

1. **Build**
```bash
cd stitch-server
cargo check -p game_server
cd crates/game_server
spacetime build
```
Expected: check/build success

2. **Inventory Loop**
```bash
spacetime start
cd stitch-server/crates/game_server
spacetime publish --server 127.0.0.1:3000 stitch-server-run003
spacetime call --server 127.0.0.1:3000 stitch-server-run003 account_bootstrap "player-three"
spacetime call --server 127.0.0.1:3000 stitch-server-run003 sign_in 1
spacetime call --server 127.0.0.1:3000 stitch-server-run003 seed_data
spacetime call --server 127.0.0.1:3000 stitch-server-run003 inventory_bootstrap
spacetime sql --server 127.0.0.1:3000 stitch-server-run003 "SELECT container_id FROM inventory_container"
spacetime call --server 127.0.0.1:3000 stitch-server-run003 item_stack_move <container_id> 0 1 3
spacetime call --server 127.0.0.1:3000 stitch-server-run003 lock_inventory_container <container_id> "trade"
spacetime call --server 127.0.0.1:3000 stitch-server-run003 item_stack_move <container_id> 1 2 1
```
Expected: 마지막 호출이 `container is locked`로 실패

## Test Coverage

- Tests added: 0
- Coverage: 0%
- Status: passing

## Developer Notes

- `item_def` 스키마를 인벤토리 검증 중심으로 조정했으므로 후속 CSV importer 구현 시 컬럼 매핑 업데이트가 필요하다.

---
*Generated by specs.md - fabriqa.ai FIRE Flow Run run-003*
