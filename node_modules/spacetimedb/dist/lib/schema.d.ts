import type RawTableDefV9 from './autogen/raw_table_def_v_9_type';
import type Typespace from './autogen/typespace_type';
import { ProductBuilder, RefBuilder, RowBuilder, SumBuilder, TypeBuilder, type Infer, type InferSpacetimeTypeOfTypeBuilder } from './type_builders';
import type { UntypedTableDef } from './table';
import { type ParamsObj, type Reducer } from './reducers';
import type RawModuleDefV9 from './autogen/raw_module_def_v_9_type';
import { AlgebraicType, type AlgebraicTypeType } from './algebraic_type';
import type RawScopedTypeNameV9 from './autogen/raw_scoped_type_name_v_9_type';
import type { CamelCase } from './type_util';
import type { UntypedTableSchema } from './table_schema';
import { type AnonymousViewFn, type ViewFn, type ViewOpts, type ViewReturnTypeBuilder } from './views';
import { type ProcedureFn } from './procedures';
export type TableNamesOf<S extends UntypedSchemaDef> = S['tables'][number]['name'];
/**
 * An untyped representation of the database schema.
 */
export type UntypedSchemaDef = {
    tables: readonly UntypedTableDef[];
};
export declare function getRegisteredSchema(): UntypedSchemaDef;
/**
 * Helper type to convert an array of TableSchema into a schema definition
 */
type TablesToSchema<T extends readonly UntypedTableSchema[]> = {
    tables: {
        readonly [i in keyof T]: TableToSchema<T[i]>;
    };
};
interface TableToSchema<T extends UntypedTableSchema> extends UntypedTableDef {
    name: T['tableName'];
    accessorName: CamelCase<T['tableName']>;
    columns: T['rowType']['row'];
    rowType: T['rowSpacetimeType'];
    indexes: T['idxs'];
    constraints: T['constraints'];
}
export declare function tablesToSchema<const T extends readonly UntypedTableSchema[]>(tables: T): TablesToSchema<T>;
/**
 * The global module definition that gets populated by calls to `reducer()` and lifecycle hooks.
 */
export declare const MODULE_DEF: Infer<typeof RawModuleDefV9>;
/**
 * Resolves the actual type of a TypeBuilder by following its references until it reaches a non-ref type.
 * @param typespace The typespace to resolve types against.
 * @param typeBuilder The TypeBuilder to resolve.
 * @returns The resolved algebraic type.
 */
export declare function resolveType<AT extends AlgebraicTypeType>(typespace: Infer<typeof Typespace>, typeBuilder: RefBuilder<any, AT>): AT;
/**
 * Adds a type to the module definition's typespace as a `Ref` if it is a named compound type (Product or Sum).
 * Otherwise, returns the type as is.
 * @param name
 * @param ty
 * @returns
 */
export declare function registerTypesRecursively<T extends TypeBuilder<any, AlgebraicType>>(typeBuilder: T): T extends SumBuilder<any> | ProductBuilder<any> | RowBuilder<any> ? RefBuilder<Infer<T>, InferSpacetimeTypeOfTypeBuilder<T>> : T;
export declare function splitName(name: string): Infer<typeof RawScopedTypeNameV9>;
/**
 * The Schema class represents the database schema for a SpacetimeDB application.
 * It encapsulates the table definitions and typespace, and provides methods to define
 * reducers and lifecycle hooks.
 *
 * Schema has a generic parameter S which represents the inferred schema type. This type
 * is automatically inferred when creating a schema using the `schema()` function and is
 * used to type the database view in reducer contexts.
 *
 * The methods on this class are used to register reducers and lifecycle hooks
 * with the SpacetimeDB runtime. Theey forward to free functions that handle the actual
 * registration logic, but having them as methods on the Schema class helps with type inference.
 *
 * @template S - The inferred schema type of the SpacetimeDB module.
 *
 * @example
 * ```typescript
 * const spacetime = schema(
 *   table({ name: 'user' }, userType),
 *   table({ name: 'post' }, postType)
 * );
 * spacetime.reducer(
 *   'create_user',
 *   {  username: t.string(), email: t.string() },
 *   (ctx, { username, email }) => {
 *     ctx.db.user.insert({ username, email, created_at: ctx.timestamp });
 *     console.log(`User ${username} created by ${ctx.sender.identityId}`);
 *   }
 * );
 * ```
 */
declare class Schema<S extends UntypedSchemaDef> {
    readonly tablesDef: {
        tables: Infer<typeof RawTableDefV9>[];
    };
    readonly typespace: Infer<typeof Typespace>;
    readonly schemaType: S;
    constructor(tables: Infer<typeof RawTableDefV9>[], typespace: Infer<typeof Typespace>, handles: readonly UntypedTableSchema[]);
    /**
     * Defines a SpacetimeDB reducer function.
     *
     * Reducers are the primary way to modify the state of your SpacetimeDB application.
     * They are atomic, meaning that either all operations within a reducer succeed,
     * or none of them do.
     *
     * @template S - The inferred schema type of the SpacetimeDB module.
     * @template Params - The type of the parameters object expected by the reducer.
     *
     * @param {string} name - The name of the reducer. This name will be used to call the reducer from clients.
     * @param {Params} params - An object defining the parameters that the reducer accepts.
     *                          Each key-value pair represents a parameter name and its corresponding
     *                          {@link TypeBuilder} or {@link ColumnBuilder}.
     * @param {(ctx: ReducerCtx<S>, payload: ParamsAsObject<Params>) => void} fn - The reducer function itself.
     *   - `ctx`: The reducer context, providing access to `sender`, `timestamp`, `connection_id`, and `db`.
     *   - `payload`: An object containing the arguments passed to the reducer, typed according to `params`.
     *
     * @example
     * ```typescript
     * // Define a reducer named 'create_user' that takes 'username' (string) and 'email' (string)
     * spacetime.reducer(
     *   'create_user',
     *   {
     *     username: t.string(),
     *     email: t.string(),
     *   },
     *   (ctx, { username, email }) => {
     *     // Access the 'user' table from the database view in the context
     *     ctx.db.user.insert({ username, email, created_at: ctx.timestamp });
     *     console.log(`User ${username} created by ${ctx.sender.identityId}`);
     *   }
     * );
     * ```
     */
    reducer<Params extends ParamsObj>(name: string, params: Params, fn: Reducer<S, Params>): Reducer<S, Params>;
    reducer(name: string, fn: Reducer<S, {}>): Reducer<S, {}>;
    /**
     * Registers an initialization reducer that runs when the SpacetimeDB module is published
     * for the first time.
     *
     * This function is useful to set up any initial state of your database that is guaranteed
     * to run only once, and before any other reducers or client connections.
     *
     * @template S - The inferred schema type of the SpacetimeDB module.
     * @param {Reducer<S, {}>} fn - The initialization reducer function.
     *  - `ctx`: The reducer context, providing access to `sender`, `timestamp`, `connection_id`, and `db`.
     * @example
     * ```typescript
     * spacetime.init((ctx) => {
     *   ctx.db.user.insert({ username: 'admin', email: 'admin@example.com' });
     * });
     * ```
     */
    init(fn: Reducer<S, {}>): void;
    init(name: string, fn: Reducer<S, {}>): void;
    /**
     * Registers a reducer to be called when a client connects to the SpacetimeDB module.
     * This function allows you to define custom logic that should execute
     * whenever a new client establishes a connection.
     * @template S - The inferred schema type of the SpacetimeDB module.
     *
     * @param fn - The reducer function to execute on client connection.
     *
     * @example
     * ```typescript
     * spacetime.clientConnected(
     *   (ctx) => {
     *     console.log(`Client ${ctx.connectionId} connected`);
     *   }
     * );
     */
    clientConnected(fn: Reducer<S, {}>): void;
    clientConnected(name: string, fn: Reducer<S, {}>): void;
    /**
     * Registers a reducer to be called when a client disconnects from the SpacetimeDB module.
     * This function allows you to define custom logic that should execute
     * whenever a client disconnects.
     * @template S - The inferred schema type of the SpacetimeDB module.
     *
     * @param fn - The reducer function to execute on client disconnection.
     *
     * @example
     * ```typescript
     * spacetime.clientDisconnected(
     *   (ctx) => {
     *     console.log(`Client ${ctx.connectionId} disconnected`);
     *   }
     * );
     * ```
     */
    clientDisconnected(fn: Reducer<S, {}>): void;
    clientDisconnected(name: string, fn: Reducer<S, {}>): void;
    view<Ret extends ViewReturnTypeBuilder>(opts: ViewOpts, ret: Ret, fn: ViewFn<S, {}, Ret>): void;
    anonymousView<Ret extends ViewReturnTypeBuilder>(opts: ViewOpts, ret: Ret, fn: AnonymousViewFn<S, {}, Ret>): void;
    procedure<Params extends ParamsObj, Ret extends TypeBuilder<any, any>>(name: string, params: Params, ret: Ret, fn: ProcedureFn<S, Params, Ret>): ProcedureFn<S, Params, Ret>;
    procedure<Ret extends TypeBuilder<any, any>>(name: string, ret: Ret, fn: ProcedureFn<S, {}, Ret>): ProcedureFn<S, {}, Ret>;
    clientVisibilityFilter: {
        sql(filter: string): void;
    };
}
/**
 * Extracts the inferred schema type from a Schema instance
 */
export type InferSchema<SchemaDef extends Schema<any>> = SchemaDef extends Schema<infer S> ? S : never;
/**
 * Creates a schema from table definitions
 * @param handles - Array of table handles created by table() function
 * @returns ColumnBuilder representing the complete database schema
 * @example
 * ```ts
 * const s = schema(
 *   table({ name: 'user' }, userType),
 *   table({ name: 'post' }, postType)
 * );
 * ```
 */
export declare function schema<const H extends readonly UntypedTableSchema[]>(...handles: H): Schema<TablesToSchema<H>>;
/**
 * Creates a schema from table definitions (array overload)
 * @param handles - Array of table handles created by table() function
 * @returns ColumnBuilder representing the complete database schema
 */
export declare function schema<const H extends readonly UntypedTableSchema[]>(handles: H): Schema<TablesToSchema<H>>;
type HasAccessor = {
    accessorName: PropertyKey;
};
export type ConvertToAccessorMap<TableDefs extends readonly HasAccessor[]> = {
    [Tbl in TableDefs[number] as Tbl['accessorName']]: Tbl;
};
export declare function convertToAccessorMap<T extends readonly HasAccessor[]>(arr: T): ConvertToAccessorMap<T>;
export {};
//# sourceMappingURL=schema.d.ts.map