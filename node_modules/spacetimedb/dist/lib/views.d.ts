import { AlgebraicType, type AlgebraicTypeVariants, type ProductType } from '../lib/algebraic_type';
import type { Identity } from '../lib/identity';
import type { OptionAlgebraicType } from '../lib/option';
import type { ParamsObj } from './reducers';
import { type UntypedSchemaDef } from './schema';
import type { ReadonlyTable } from './table';
import { type Infer, type InferSpacetimeTypeOfTypeBuilder, type InferTypeOfRow, type TypeBuilder } from './type_builders';
import { type QueryBuilder, type RowTypedQuery } from '../server/query';
export type ViewCtx<S extends UntypedSchemaDef> = Readonly<{
    sender: Identity;
    db: ReadonlyDbView<S>;
    from: QueryBuilder<S>;
}>;
export type AnonymousViewCtx<S extends UntypedSchemaDef> = Readonly<{
    db: ReadonlyDbView<S>;
    from: QueryBuilder<S>;
}>;
export type ReadonlyDbView<SchemaDef extends UntypedSchemaDef> = {
    readonly [Tbl in SchemaDef['tables'][number] as Tbl['name']]: ReadonlyTable<Tbl>;
};
export type ViewOpts = {
    name: string;
    public: true;
};
type FlattenedArray<T> = T extends readonly (infer E)[] ? E : never;
export type ViewFn<S extends UntypedSchemaDef, Params extends ParamsObj, Ret extends ViewReturnTypeBuilder> = ((ctx: ViewCtx<S>, params: InferTypeOfRow<Params>) => Infer<Ret>) | ((ctx: ViewCtx<S>, params: InferTypeOfRow<Params>) => RowTypedQuery<FlattenedArray<Infer<Ret>>, ExtractArrayProduct<Ret>>);
export type AnonymousViewFn<S extends UntypedSchemaDef, Params extends ParamsObj, Ret extends ViewReturnTypeBuilder> = ((ctx: AnonymousViewCtx<S>, params: InferTypeOfRow<Params>) => Infer<Ret>) | ((ctx: AnonymousViewCtx<S>, params: InferTypeOfRow<Params>) => RowTypedQuery<FlattenedArray<Infer<Ret>>, ExtractArrayProduct<Ret>>);
export type ViewReturnTypeBuilder = TypeBuilder<readonly object[], {
    tag: 'Array';
    value: AlgebraicTypeVariants.Product;
}> | TypeBuilder<object | undefined, OptionAlgebraicType<AlgebraicTypeVariants.Product>>;
export declare function defineView<S extends UntypedSchemaDef, const Anonymous extends boolean, Params extends ParamsObj, Ret extends ViewReturnTypeBuilder>(opts: ViewOpts, anon: Anonymous, params: Params, ret: Ret, fn: Anonymous extends true ? AnonymousViewFn<S, Params, Ret> : ViewFn<S, Params, Ret>): void;
type ViewInfo<F> = {
    fn: F;
    params: ProductType;
    returnType: AlgebraicType;
    returnTypeBaseSize: number;
};
export declare const VIEWS: ViewInfo<ViewFn<any, any, any>>[];
export declare const ANON_VIEWS: ViewInfo<AnonymousViewFn<any, any, any>>[];
type ExtractArrayProduct<T extends TypeBuilder<any, any>> = InferSpacetimeTypeOfTypeBuilder<T> extends {
    tag: 'Array';
    value: infer V;
} ? V extends {
    tag: 'Product';
    value: infer P;
} ? P : never : never;
export {};
//# sourceMappingURL=views.d.ts.map