# 동기화 및 안티치트 계약

이 문서는 서버 권위 검증, 실시간 동기화, 위반 탐지/제재의 구현 계약을 정의한다.
모든 판정은 서버 reducer 기준으로 수행한다.

## 1) 서버 권위와 클라이언트 예측 경계

| 영역 | 서버 권위 | 클라이언트 허용 |
|---|---|---|
| 이동 | 최종 위치/충돌/속도 판정 | 입력 예측 및 보간 |
| 행동/스킬 | 쿨다운/자원/사거리/완료 판정 | 시작 애니메이션 예측 |
| 전투 | 타격 유효성/피해/상태이상 적용 | 히트 연출 예측 |
| 거래 | 세션 상태/잠금/체결/롤백 | UI 상태 표시 |

원칙:
- 클라이언트는 체감 반응성 보조만 수행한다.
- 최종 상태는 서버 이벤트/스냅샷으로 수렴한다.

## 2) 상태 동기화 계약

| 항목 | 기준 |
|---|---|
| 스냅샷 주기 | 10-20Hz |
| 이벤트 푸시 | 타격/거래체결/상태전이 등 중요 이벤트 즉시 전송 |
| 전송 단위 | 관심 영역 기반 델타 + 변경 필드 중심 |
| 구독 모델 | 테이블 구독 기반 자동 전파 |

## 3) reducer 검증 매핑

| 도메인 | Reducer 패턴 | Entry Validation | Impact Validation |
|---|---|---|---|
| 이동 | `move_*` | timestamp 단조 증가, 입력 빈도, 속도/가속 상한 | 서버 tick 위치/충돌 재확인 |
| 행동 | `action_*` | 쿨다운, 자원 비용, 상태 가능 여부 | 진행률 허용창(80~95%) 재확인 |
| 전투 | `attack_start`/`attack_scheduled`/`attack_impact` | 사거리, 무기 상태, 쿨다운 | 타격 시점 거리/타겟/쿨다운 재검증 |
| 거래 | `trade_*` | 세션 유효성, 잠금 가능 여부, 요청 레이트 | 체결 시 인벤토리/잠금/롤백 재검증 |

검증 규칙:
- 1차 검증은 reducer 진입 시점에 수행한다.
- 2차 검증은 실제 영향 발생 시점(타격/완료/체결)에 수행한다.

## 4) 고핑 보정 및 레이트 리미팅

| 항목 | 기준 |
|---|---|
| 고핑 허용창 | 지연 허용 범위 내 입력만 수용 |
| 초과 입력 처리 | 서버 권위 위치/상태로 즉시 보정 |
| 액션 레이트 제한 | 액션 유형별 분당/초당 호출 상한 적용 |
| 채팅/거래 제한 | 채널/세션별 별도 상한 적용 |

## 5) 이상 탐지 기준

| 탐지 축 | 기준 예시 |
|---|---|
| 이동 이상 | 반복 텔레포트 패턴, 속도/가속 상한 초과 |
| 전투 이상 | 비정상 DPS, 쿨다운 무시 시도 |
| 자원 이상 | 자원 생성/소비 불일치 |
| 거래 이상 | 잠금 회피, 중복 체결 시도 |

탐지 결과는 `moderation_flag`(또는 동등 상태 테이블)에 누적한다.

## 6) 위반 점수 및 제재 상태 전이

| 단계 | 상태 | 전이 조건 | 처리 |
|---|---|---|---|
| 0 | 정상 | 기본 상태 | 일반 처리 |
| 1 | 경고 | 경미 위반 점수 임계치 도달 | 경고 기록/추가 모니터링 |
| 2 | 자동 제한 | 중간 임계치 도달 | 이동/거래/행동 일부 제한 |
| 3 | 수동 검토 | 반복 또는 고위험 패턴 | 운영 검토 큐 등록 |
| 4 | 영구 제재 | 검토 확정 또는 치명 위반 | 영구 제한 |

기본 흐름: `정상 -> 경고 -> 자동 제한 -> 수동 검토 -> 영구 제재`

## 7) 스케줄드 reducer 보안

- 스케줄드 reducer는 server/admin 권한 검증 후 실행한다.
- 비상 상황에서는 에이전트 플래그로 안전 정지할 수 있어야 한다.
- 운영 환경에서 인증/권한 우회 모드는 비활성화한다.
