# Stitch 게임 서버 테스트 케이스 설계

> **작성일**: 2026-02-01
> **상태**: DESIGN/DETAIL - 테스트 설계
> **범위**: 핵심 서버 기능 단위/통합/부하/보안 테스트

---

## 1. 테스트 원칙

- 서버 권위 로직은 **리듀서 중심**으로 검증한다.
- 테스트는 `단위 → 통합 → 부하 → 장애 복구` 순으로 단계화한다.
- 정적 데이터 의존 테스트는 **고정 시드**로 재현성을 확보한다.

---

## 2. 단위 테스트 (핵심 리듀서)

### 2.1 인증/세션

| ID | 시나리오 | 입력 | 기대 결과 |
|----|----------|------|-----------|
| AUTH-001 | 신규 계정 부트스트랩 | `account_bootstrap(display_name)` | `account`, `account_profile` 생성 |
| AUTH-002 | 중복 부트스트랩 | 동일 호출 2회 | 중복 생성 없음 |
| AUTH-003 | 로그인 성공 | `sign_in(region_id)` | `session_state` 생성 |
| AUTH-004 | 차단 계정 로그인 | `moderation_flag.score >= limit` | 로그인 거부 |
| AUTH-005 | 로그아웃 | `sign_out(session_id)` | `session_state` 삭제 |

### 2.2 인벤토리

| ID | 시나리오 | 입력 | 기대 결과 |
|----|----------|------|-----------|
| INV-001 | 동일 아이템 스택 합치기 | `item_stack_move` | 수량 합산/포켓 유지 |
| INV-002 | 포켓 용량 초과 | 대량 아이템 이동 | 초과분 드랍 |
| INV-003 | 잠금 포켓 이동 | `inventory_lock` 후 이동 | 이동 실패 |
| INV-004 | 내구도 0 변환 | 내구도 0 아이템 | 변환/드랍 처리 |

### 2.3 전투

| ID | 시나리오 | 입력 | 기대 결과 |
|----|----------|------|-----------|
| CBT-001 | 공격 시작 검증 실패 | 사거리 초과 | `attack_start` 실패 |
| CBT-002 | 공격 성공 처리 | 정상 공격 | `attack_outcome` 생성 |
| CBT-003 | 위협 업데이트 | 피해 발생 | `threat_state` 증가 |
| CBT-004 | 치트 시도 | 쿨다운 무시 | 서버 거부 |

### 2.4 퀘스트/업적

| ID | 시나리오 | 입력 | 기대 결과 |
|----|----------|------|-----------|
| QST-001 | 퀘스트 시작 | 요구조건 충족 | `quest_chain_state` 생성 |
| QST-002 | 스테이지 완료 | 조건 충족 | 스테이지 진행 |
| ACH-001 | 업적 획득 | 조건 충족 | `achievement_state` 갱신 |

---

## 3. 통합 테스트

### 3.1 거래/경매

| ID | 시나리오 | 입력 | 기대 결과 |
|----|----------|------|-----------|
| TRD-001 | 직접 거래 완료 | 양측 수락 | 아이템/화폐 교환 |
| TRD-002 | 거래 중 이탈 | 한쪽 로그아웃 | 세션 종료, 포켓 해제 |
| AUC-001 | 매도 주문 체결 | 매수 주문 존재 | `order_fill` 기록 |

### 3.2 클레임/권한

| ID | 시나리오 | 입력 | 기대 결과 |
|----|----------|------|-----------|
| CLM-001 | 클레임 확장 | 인접 타일 | 확장 성공 |
| CLM-002 | 권한 없는 건물 사용 | Visitor 접근 | 사용 거부 |

### 3.3 NPC AI

| ID | 시나리오 | 입력 | 기대 결과 |
|----|----------|------|-----------|
| NPC-001 | 행동 스케줄 만료 | `next_action_ts` 경과 | 행동 요청 생성 |
| NPC-002 | 정책 위반 응답 | 금지 키워드 포함 | `npc_policy_violation` 기록 |
| NPC-003 | 대화 세션 만료 | `last_ts` 경과 | 세션 정리 |

---

## 4. 부하 테스트

### 4.1 동시 접속

- 5k/10k 동시 세션 생성
- `session_state`/`account_profile` 조회 부하 측정

### 4.2 AOI 구독

- 1k/5k 플레이어 이동
- `combat_stream`, `building_stream` 구독 처리 시간 측정

### 4.3 에이전트

- `npc_ai`, `resource_regen` 동시 실행 시 tick 처리량 측정

---

## 5. 보안 테스트

| ID | 시나리오 | 입력 | 기대 결과 |
|----|----------|------|-----------|
| SEC-001 | 권한 상승 시도 | role 낮은 계정 | 리듀서 거부 |
| SEC-002 | 세션 하이재킹 | 타인 session_id | 거부 |
| SEC-003 | RLS 누출 | private 테이블 구독 | 데이터 없음 |

---

## 6. 장애/복구 테스트

| ID | 시나리오 | 입력 | 기대 결과 |
|----|----------|------|-----------|
| REC-001 | 에이전트 중복 타이머 | 타이머 2개 | 오류 로그 발생 |
| REC-002 | 서버 재시작 | init 재실행 | 타이머 1개만 존재 |
| REC-003 | 정적 데이터 손상 | 누락 CSV | 로딩 실패/검증 경고 |

---

## 7. 테스트 데이터 세트

- `fixtures/base_world.json`
- `fixtures/test_accounts.json`
- `fixtures/item_defs_min.csv`

---

## 8. 관련 문서

- DESIGN/DETAIL/agent-system-design.md
- DESIGN/DETAIL/stitch-combat-and-pvp.md
- DESIGN/DETAIL/stitch-inventory-item-stacks.md
- DESIGN/DETAIL/stitch-quest-achievement.md
- DESIGN/DETAIL/stitch-authentication-authorization.md
- DESIGN/11-testing-evaluation.md

---

## 9. 자동화 실행 순서 (파이프라인)

### 9.1 기본 파이프라인 (PR 기준)

1) **정적 검사**
- 포맷/린트/정적 분석

2) **단위 테스트**
- auth/inventory/combat/quest 핵심 리듀서 중심

3) **통합 테스트**
- 거래/클레임/NPC AI 경로

4) **회귀 스냅샷**
- 주요 테이블 상태 스냅샷 비교

### 9.2 야간 파이프라인 (배치)

1) **부하 테스트**
- 동시 접속 + AOI 구독

2) **장애/복구 테스트**
- 에이전트 타이머 중복/재기동 검증

3) **보안 테스트**
- 권한 상승/세션 하이재킹 시나리오

### 9.3 실패 처리 규칙

- 정적 검사 실패 시 즉시 중단
- 단위/통합 실패 시 배치 테스트 스킵
- 회귀 스냅샷 실패 시 PR 블록

### 9.4 산출물

- 테스트 리포트 (JUnit/JSON)
- 커버리지 리포트
- 실패 시 서버 상태 덤프
