# 시스템 디자인

## 좌표/월드
- 좌표계: 헥스 그리드 기반 좌표와 오프셋 좌표 변환.
- 월드 구조: 지역(Region)과 청크(Chunk) 분리, 다중 차원 지원.
- 월드 생성: 노이즈 기반 지형/바이옴/자원 배치.

## 월드 생성 상세
- 지형 레이어: 고도 노이즈 -> 수계/경사 보정.
- 바이옴 맵: 온도/습도/고도 조합.
- 자원 배치: 바이옴 가중치 + 군집(Clump) 배치.
- 생성 순서: 지형 -> 바이옴 -> 자원 -> 구조물.
- 특수 장소: 수동 템플릿(고대 유적/던전) + 프로시저럴 배치 규칙으로 생성.

## 좌표/청크 상세
- 좌표 변환: 헥스 <-> 오프셋, 월드 좌표 변환 제공.
- 청크 인덱싱: 좌표 해시 기반 조회.
- 관심 영역: 주변 청크 3x3 스트리밍.
- 타일 크기: 1타일 = 1.75m(기준).
- 이동 속도: 기본 보행 기준 1타일 0.8초 내외.
- 구독 패턴: region_id + instance_id + aoi_tiles 목록으로 AOI 구독.
- 구독 전환: 플레이어가 청크 경계 이동 시 AOI 목록 갱신/재구독.

## AOI/스트리밍 성능
- terrain_chunk는 정적 데이터로 1회 전송 + 캐시.
- 동적 데이터는 AOI 필터 + 델타 전송.
- 겹치는 청크는 서버 캐시 공유로 전송량 절감.
- 대규모 동접 시 AOI 축소/LOD/갱신 주기 완화 옵션 제공.

## 이동/행동
- 액션 처리: 클라이언트 요청 -> 핸들러(리듀서) 검증 -> 상태 테이블 갱신.
- 이동 제약: 속도/가속 제한, 충돌 검사, 지형 제약.
- 자원 소모: 행동별 스태미나/내구도/재료 비용.

## 에이전트(주기 작업)
- 재생성: 체력/스태미나/자원 재생.
- 감가: 건축물 감가/수리.
- 일주기: 낮/밤 주기와 환경 효과.
- NPC AI: 주기 업데이트로 행동 결정.

## 전투
- 역할군: 탱커, 서포터, 근접 딜러, 원거리 딜러, 유틸리티.
- 피해 모델: 체력/방어/저항 기반, 속성 상성, 치명타와 약점 노출.
- 상태 이상: 출혈, 화상, 감속, 기절, 속박, 동결.
- 전투 상태: CombatState/AttackOutcome/Threat 등 상태 기반 관리.

## 전투 흐름
- 공격 시작: 검증 -> 예약 타이머 생성.
- 타격 판정: 거리/타겟/쿨다운 확인.
- 피해 계산: 치명타/회피/저항 적용.
- 위협 시스템: 위협 점수 기반 타겟팅.

## PvP
- 모드: 선택형 아레나 + 제한적 영토 분쟁.
- 보호 구역: 초반 지역 및 거점은 PvP 제한.
- 보상/페널티: 순위/칭호 중심, 파괴적 손실 최소화.

## 스킬
- 획득 방식: 사용 기반 해금 + NPC 멘토링 + 제작 전용 스킬.
- 성장 방식: 숙련도 누적, 소프트 캡, 상황별 리스펙 토큰.

## 아이템/장비
- 희귀도 티어: 일반, 고급, 희귀, 영웅, 전설.
- 능력치: 공격/방어, 속성 보정, 유틸(채집 속도 등).
- 내구도: 사용으로 감소, 수리 비용과 부품 필요.

## 인벤토리/스택
- 스택 규칙: 아이템 타입별 최대 스택.
- 잠금: 거래/제작 중 포켓 잠금.
- 발견(Discovery): 미발견 아이템은 거래/퀘스트 제한.

## 제작
- 입력 재료: 지역별 자원, 정제 재료, 희귀 촉매.
- 산출물: 장비, 소비 아이템, 건축 모듈, 거래품.
- 품질: 제작 숙련도와 재료 등급으로 품질 등급 결정.

## 건축/클레임
- 건축 흐름: 프로젝트 사이트 배치 -> 자재 투입 -> 완공.
- 클레임 구조: 건물(토템) 기반 소유, 타일 단위 영토.
- 유지/감가: 건축물 유지비와 공급 부족 시 감가.

## 건축 세부
- 풋프린트: Walkable/Hitbox/Decorative 타일 구분.
- 프로젝트 사이트: 진행률/자재 체크, 완료 시 전환.
- 인테리어: 임대 공간은 화이트리스트 권한 적용.

## 클레임 확장 규칙
- 인접 타일만 확장 가능.
- 다른 클레임과 최소 거리 유지.
- 초기 반경 이내는 제거 제한.
- 분리/고립 방지 체크.

## 권한/접근
- 권한 계층: Owner/CoOwner/Build/Inventory/Usage 등 단계형 권한.
- 권한 그룹: 플레이어/클레임/엠파이어/전체 공개.
- 상호작용 레벨: 건물 설명의 접근 등급으로 1차 필터.

## 권한 해석 순서
- 엔티티 권한 -> 인테리어 -> 클레임 권한 순으로 평가.
- OverrideNoAccess는 최우선 차단.
- 그룹 권한: 플레이어/클레임/엠파이어/전체.

## 거래
- 직접 거래: 세션 기반 교환, 아이템 잠금.
- 경매형 주문: 매수/매도 주문과 상시 체결.
- 상점형 주문: 바터 스톨(거래소/상점)에서 고정 주문.

## 거래 안전장치
- 직접 거래: 인벤토리 포켓 잠금, 시간 제한.
- 주문장: 체결 로그와 환불 기록.
- 바터 스톨: 거리 제한, 권한 검증.

## 퀘스트/업적
- 트리거: NPC 대화/전투/제작/탐험.
- 스테이지: 조건 충족 -> 보상 -> 분기.
- 검증: 서버 상태 테이블 기반 확인.

## 파티/레이드
- 그룹 규모: 파티 4-5인, 레이드 12-16인.
- 매칭 방식: 파티는 자동 매칭, 레이드는 수동 모집 중심.

## 길드
- 혜택: 공동 창고, 길드 프로젝트, 사회적 버프.
- 권한: 역할 기반 권한, 프로젝트 승인, 자원 집행.

## 월드 이벤트
- 트리거: 계절 변화, 자원 고갈, NPC 요청, 지역 분쟁.
- 보상: 화폐, 청사진, 장식 아이템, 평판.

## 경로 탐색
- 알고리즘: 헥스 A* 기반.
- 비용: 지형/장애물/위험도 가중치.
- 캐시: 경로 캐시와 시간 기반 무효화.

## 기본 수치(초안)
- 거래 거리: 직접 거래 6타일, 바터 스톨 5타일.
- 거래 세션 타임아웃: 45초.
- 클레임 토템 최소 거리: 8타일.
- 스냅샷 주기: 15Hz 기본.
- 전투 전역 쿨다운: 0.6초.
- 공격 예약 지연: 0.2-0.8초.
- 자원 재생 주기: 60초.
- 낮/밤 주기: 30분.

## 세부 설계 (BitCraft 참고)

### 헥스 좌표/청크
- 좌표: 큐브 좌표(x,z + y=-x-z) + dimension 필드로 다차원 지원.
- 변환: Hex<->Offset 변환 공식, 월드 좌표 변환(Inner/Outer radius)로 렌더/충돌 공유.
- 방향: 12방향(면 6 + 꼭짓점 6)으로 이동/방향 계산, 모듈러 연산 회전.
- 청크: 32x32 타일 청크, chunk_index = (dimension-1)*1,000,000 + z*1000 + x + 1.
- 스트리밍: 중심 청크 3x3 주변 조회를 기본 구독/로드 범위로 사용.

### 월드 생성 파이프라인
- 입력: WorldDefinition(곡선/노이즈/바이옴/자원/빌딩 설정).
- 단계: TerrainGraph -> Buildings -> Resources (고정 순서).
- 그래프 분리: TerrainGraph(1x) vs EntityGraph(3x)로 지형/엔티티 해상도 분리.
- 지형: OpenSimplex fBm(옥타브/퍼시스턴스/라쿠너리티) + 해안 거리 곡선/마운틴/바이옴 커브 합성.
- 수계: 노이즈 기반 호수 + 경사 기반 강 생성, 노드 타입(Sea/Lake/River/Land) 저장.
- 바이옴: BiomesMapDefinition의 공간 인덱스 기반, 전이 길이와 거리 곡선으로 경계 스무딩.
- 자원: ResourceDefinition(클럼프, 고도/수심 범위, 바이옴별 확률/노이즈)로 배치.
- 출력: TerrainChunkState(32x32), GeneratedBuilding, GeneratedResourceDeposit, Dimension 메타.

### 에이전트(주기 작업)
- 스케줄: 각 에이전트는 scheduled table + reducer 루프, parameters_desc_v2에서 tick 설정.
- 공통 게이트: server/admin 검증 + agents_enabled 플래그로 일괄 ON/OFF.
- 주요 에이전트: player/enemy regen, resource regen/growth, building decay, npc ai, environment debuff, day/night, trade session cleanup, auto logout.

### 이동/행동 디테일
- 이동 검증: 타임스탬프 순서, 속도 상한, 고도 차(예: 6 이상) 제한, 충돌/풋프린트 검사.
- 달리기: 스태미나 소모 기반, cargo 보유 시 러닝 금지, 부족 시 자동 걷기 전환.
- 액션 레이어: Base/UpperBody 2레이어로 동시 행동 제어.
- 액션 타이밍: 진행 80~95% 구간에 대한 서버 검증으로 클라 조작 차단.

### 전투 세부
- 공격 흐름: attack_start -> scheduled timer(풍속/투사체) -> attack_impact.
- 위협 시스템: ThreatState 누적 + 도발 equalize, 다수 공격자에 따른 EnemyScalingState 적용.
- 결과 기록: AttackOutcomeState(피해/치명/회피)로 클라 피드백 동기화.
- 전투/재생: 전투 중엔 패시브 재생성 차단, regen agent로 회복 처리.

### 제작/건축/클레임
- 건축: project site(자재 투입/액션 진행) -> 완료 시 빌딩 상태 생성.
- 자재: item/cargo 구분, 과투입 방지, 기여량 기반 진행 제한.
- 진행: 스태미나/도구 내구 소모, 스킬/툴 파워에 따른 진행량 보정.
- 클레임: 타일 인접 확장, 최대 타일=클레임 테크, 분리/고립 방지 플러드필 체크.

### 인벤토리/스택
- 포켓: 볼륨 기반 용량, locked 플래그로 거래/제작 중 이동 금지.
- 아이템 타입: Item/Cargo 분리, cargo_index로 슬롯 타입 분할.
- 발견(Discovery): 아이템/지식 자동 등록, 아이템 리스트(확률 테이블) 처리.
