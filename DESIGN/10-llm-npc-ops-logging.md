# LLM/VLM NPC 운영 및 로깅

## 로깅 범위
- 대화: 텍스트, 요약, 의도 태그.
- 의사결정: 퀘스트 생성, 가격 조정, 경고 트리거.
- 시스템: 모델/프롬프트/필터 버전, 라우팅 결과, 토큰 사용량.
- 실패: 타임아웃/폴백/정책 차단 원인.

## 데이터 보관
- 보관 기간: 90일 기본, 익명화 후 장기 보관.
- 마스킹 규칙: 개인식별/민감정보 자동 제거.
- 샘플링: 고비용/고위험 세션만 풀 로그, 일반 세션은 요약 로그.

## 감사
- 리플레이 도구: 대화 재생과 상태 스냅샷 조회.
- 접근 통제: 역할 기반 접근, 감사 로그 유지.
- 변경 이력: 퀘스트/주문 생성의 서버 검증 결과 기록.

## 모델 버전 관리
- 버전 태그: 모델/프롬프트/필터 버전 분리.
- 롤아웃 전략: 5% -> 25% -> 100% 점진 배포.
- 실패 기준: 위반률/오탐률/지연이 임계값 초과 시 롤백.

## 테이블/이벤트
- 대화 로그 테이블: 세션/턴/안전 플래그.
- NPC 상태 테이블: 관계치/기억 요약/감정 상태.
- 이벤트 스트림: 퀘스트 생성/취소/분기 기록.
- 비용 이벤트: 토큰/비용/지연 기록 테이블.

## 세부 설계 (BitCraft 참고)

### 로그 스키마(권장 필드)
- session_id, npc_entity_id, player_entity_id, timestamp.
- input_summary, output_summary, intent_tag.
- model_version, prompt_version, filter_version.
- token_in, token_out, latency_ms, route_tier.
- policy_blocked(bool), block_reason, fallback_used(bool).

### 운영 지표
- NPC 행동 주기: next_action_timestamp 간격 분포, 이동/갱신 성공률.
- 경제 영향: NPC trade_order 생성/삭제 건수, 체결률.
- 안전 지표: 정책 위반율, 신고율, 자동 차단율.
- 비용 지표: 세션당 평균 비용, 상위 5% 비용 분포.

### 상태 변경 감사
- 이동/스폰: building_entity_id 변경, previous_buildings 업데이트 로그.
- 거래: trade_order 생성/삭제, barter/auction 연동 기록.
- 퀘스트: chain/stage 생성, 보상 지급 로그.
- 권한: 정책 차단/승인 이벤트 기록.

### 장애 대응
- 에이전트 실패 시 재시도/스킵 카운트 기록.
- 규칙 위반 응답은 안전 플래그 + 원인 코드 저장.
- 장애 시 안전 모드 전환 로그 + 롤백 이벤트 기록.

### 운영 알림
- 비용 80%/95% 도달 알림.
- 정책 위반율 급증/지연 P95 초과 알림.
