# LLM/VLM NPC 설계

## 목표
- 세계관 몰입도 향상과 동적 퀘스트 생성.
- 플레이어 행동에 대한 서사적 피드백 제공.

## 시스템 구조
- 대화 리듀서: NPC 대화 요청 처리와 응답 반영.
- 상태 테이블: NPC 상태/관계/기억 요약 저장.
- 에이전트: 주기적으로 NPC 상태 갱신 및 기억 요약.
- 툴 게이트웨이: 월드/경제/퀘스트 조회 전용 함수 집합(쓰기 금지).

## NPC 역할
- 퀘스트 담당: 상황 기반 임무 생성/분기.
- 동행: 전투 보조, 안내, 상호작용.
- 상인: 수요/공급 기반 재고와 가격 조정.
- 마을 AI: 소문 전파, 관계 변화, 생활 루프.
- 운영 안내: 이벤트/공지/규칙 안내(권한/정책 범위 내).

## 행동 제한
- 허용 행동: 대화, 정보 안내, 퀘스트 트리거.
- 금지 행동: 경제 붕괴 유도, 메타 정보 누설.
- 금지: 서버 상태 직접 변경, 권한 상승, 보상 무한 생성.

## 행동 정책(초안)
- 경제 영향: 가격 변경은 하루 1회, 변동폭 5% 이내.
- 퀘스트 생성: 하루 1인당 3개까지.
- NPC 동행: 1인당 1명 제한.
- 거래/가격: 서버가 상한/쿨다운 검증 후 적용.
- 대화 빈도: 동일 플레이어 연속 요청 레이트 리미팅.

## 메모리 모델
- 단기: 최근 대화 요약 5-10턴.
- 장기: 관계치, 주요 사건 태그, 평판 기록.
- 세계 기억: 지역 루머/이벤트 요약(지역 스코프).

## 성격과 톤
- 스타일 가이드: 친근하고 실용적, 세계관 어휘 사용.
- 지역 규칙: 지역/세력별 어휘와 억양 차등.
- 말투 안전: 금칙 주제 회피, 단정 대신 제한적 안내.

## 툴링 연동
- 월드 상태 접근: 위치, 시간, 자원, 이벤트 상태 조회.
- 퀘스트 트리거: 서버 검증 후 퀘스트 생성/수정.
- 거래 상태 접근: NPC 주문/재고는 읽기 전용 조회.

## NPC 상태 테이블
- 관계치: 플레이어별 호감/신뢰.
- 기억 요약: 마지막 사건/약속.
- 감정 상태: 현재 무드/스트레스.
- 행동 타이머: next_action_timestamp.
- 이동 이력: previous_buildings(최근 방문 목록).

## 모델 오케스트레이션
- 경량 모델: 일반 대화/안내.
- 상위 모델: 퀘스트 생성/복합 추론.
- 안전 필터: 출력 전 필터와 정책 체크.
- 정책 프롬프트: 시스템/보안/권한/세계관을 분리 유지.

## 데이터 흐름
- 입력: 플레이어 발화 + 컨텍스트 스냅샷.
- 처리: 모델 응답 -> 정책 필터 -> 리듀서 반영.
- 출력: 대화 응답 + 상태 변경 이벤트.

## 대화 세션 설계
- 세션 키: (player_entity_id, npc_entity_id, conversation_id).
- 상태 전이: Idle -> Active -> Cooldown -> Closed.
- 요약 저장: 세션 종료/토큰 상한 도달 시 요약 테이블 업데이트.

## 컨텍스트 구성 (권장)
- Player: 위치/상태/퀘스트 진행/평판/최근 선택.
- NPC: 역할/상태/기억 요약/행동 쿨다운.
- World: 시간/바이옴/근처 이벤트/클레임 소속.
- Economy: 기본 가격 밴드/거래 제한/정책 플래그.
- Safety: 금칙/민감 주제 정책, 허용된 액션 리스트.

## 퀘스트/거래 생성 흐름
1. LLM 제안(후보안) 생성.
2. 서버 규칙 검증(요구조건/쿨다운/보상 상한).
3. 검증 통과 시 QuestChain/Stage 또는 TradeOrderState 기록.
4. 클라이언트에는 확정 결과만 전송.

## 세부 설계 (BitCraft 참고)

### NPC 상태/행동 베이스라인
- NPCState 필드: building_entity_id, traveling 플래그, next_action_timestamp, previous_buildings(최근 3개).
- 타입 분리: 여행형(ruin 이동) vs 고정형(주기적 거래 갱신).
- 위치 갱신: BuildingSpawnDesc 기반 스폰 좌표 계산 후 MobileEntityState 업데이트.

### 스케줄링/행동 주기
- NPC AI는 5분 주기 에이전트로 이동/갱신 처리.
- LLM 대화는 에이전트와 분리하되, 행동 결과는 reducer로만 반영.
- LLM이 생성한 퀘스트/주문은 서버 검증 후 테이블에 기록.

### 거래/퀘스트 생성 연동
- 기본 상시 주문(always_offered) + 랜덤 선택(selected_traveler_order_count) 조합.
- 퀘스트는 QuestChain/Stage 구조를 사용, 보상은 Inventory/Discovery에 적용.

### 컨텍스트 스냅샷 구성
- 위치/바이옴/시간/근처 건물/클레임 상태/플레이어 관계치.
- 거래/퀘스트 쿨다운과 NPC next_action_timestamp 포함.
 - recent_trades/quest_history는 요약 정보만 포함(PII 제거).
